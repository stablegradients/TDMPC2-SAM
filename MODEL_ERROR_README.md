# Model Error Computation for TD-MPC2

This repository contains scripts to compute the average model error (MSE) on test buffers using trained TD-MPC2 agents.

## Overview

The model error is computed as the Mean Squared Error (MSE) between:
- **Predicted next latent states**: Generated by the dynamics model
- **Actual next latent states**: Encoded from actual observations

This is the same consistency loss used during training (see `tdmpc2.py` line 229):
```python
consistency_loss = consistency_loss + F.mse_loss(z, _next_z) * self.cfg.rho**t
```

## Scripts

### 1. `compute_model_error.py`

Main script that loads agent and buffer checkpoints and computes model error statistics.

**Usage:**
```bash
python compute_model_error.py \
    --agent-checkpoint <path_to_agent_checkpoint> \
    --buffer-checkpoint <path_to_test_buffer_checkpoint> \
    [--config <path_to_config_file>] \
    [--task <task_name>] \
    [--horizon <prediction_horizon>] \
    [--device <cuda_device>]
```

**Arguments:**
- `--agent-checkpoint` (required): Path to agent checkpoint (.pt file)
- `--buffer-checkpoint` (required): Path to test buffer checkpoint (.pt file)
- `--config` (optional): Path to config.yaml file
- `--task` (optional): Task name (default: dog-run)
- `--horizon` (optional): Prediction horizon (default: 3)
- `--device` (optional): Device to run on (default: cuda:0)

**Example:**
```bash
# For dog-run environment
python compute_model_error.py \
    --agent-checkpoint buffer_logging/checkpoints/dog-run_checkpoint_test_seed0/agent/1000000.pt \
    --buffer-checkpoint buffer_logging/checkpoints/dog-run_checkpoint_test_seed0/test/1000000.pt \
    --task dog-run
```

### 2. `generate_test_data.py`

Helper script to generate test data by running a trained agent in the environment.

**Usage:**
```bash
python generate_test_data.py \
    --agent-checkpoint <path_to_agent_checkpoint> \
    --output-path <path_to_save_buffer> \
    [--task <task_name>] \
    [--num-episodes <number_of_episodes>] \
    [--device <cuda_device>]
```

## Checkpoint Structure

Based on `test_checkpoint_saving.sh`, checkpoints are saved in the following structure:
```
buffer_logging/checkpoints/{exp_name}_seed{seed}/
├── agent/
│   └── {steps}.pt          # Agent model and optimizer states
├── test/
│   └── {steps}.pt          # Test buffer data
└── train/
    └── {steps}.pt          # Training buffer data
```

## Output

The `compute_model_error.py` script provides:

1. **Console output:**
   - Per-timestep MSE for the first batch (shows error growth over horizon)
   - Progress updates during batch processing
   - Final statistics summary

2. **Saved results:**
   - Results are saved to `{agent_checkpoint}_model_error.txt`
   - Contains all statistics and metadata

**Statistics computed:**
- **Average MSE**: Mean model error across all batches
- **Std Dev MSE**: Standard deviation of batch errors
- **Min/Max MSE**: Range of errors observed
- **Num Batches**: Number of batches processed
- **Num Episodes**: Total episodes in the buffer
- **Horizon**: Prediction horizon used

## Implementation Details

1. **Model Error Computation:**
   - For each batch of trajectories from the buffer
   - Encode current and next observations
   - Roll out dynamics model using actions
   - Compute MSE between predicted and actual next latent states
   - Average over prediction horizon

2. **Batching:**
   - Processes up to 100 batches for stable statistics
   - Uses the same batch size as training (default: 256)

3. **Configuration:**
   - Automatically infers environment parameters
   - Uses default TD-MPC2 hyperparameters if config not provided
   - Handles both single-task and multi-task settings

## Notes

- The script handles empty buffers gracefully
- Uses EGL rendering to avoid display issues on headless systems
- Compatible with all TD-MPC2 supported environments
- The error typically increases with prediction horizon due to compounding errors

## Example Workflow

1. Train an agent using TD-MPC2:
   ```bash
   python tdmpc2/train.py task=dog-run steps=1000000
   ```

2. Find checkpoint paths:
   ```bash
   ls buffer_logging/checkpoints/*/agent/*.pt
   ls buffer_logging/checkpoints/*/test/*.pt
   ```

3. Compute model error:
   ```bash
   python compute_model_error.py \
       --agent-checkpoint <agent_checkpoint_path> \
       --buffer-checkpoint <test_buffer_path> \
       --task dog-run
   ```

4. View results:
   ```bash
   cat <agent_checkpoint_path>_model_error.txt
   ``` 